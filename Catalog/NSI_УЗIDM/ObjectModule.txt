
Процедура ПередЗаписью(Отказ)
	Если ЭтоНовый() Тогда
		ID = Новый УникальныйИдентификатор();
		УстановитьСсылкуНового(Справочники.NSI_УЗIDM.ПолучитьСсылку(ID));
		UserID = Строка(ID);
		ДополнительныеСвойства.Вставить("СписокУЗВИБ", Новый Массив);
		ДополнительныеСвойства.Вставить("СписокРолейIDM", Новый Массив);
	Иначе
		ДополнительныеСвойства.Вставить("СписокУЗВИБ", Ссылка.УЗВИБ.ВыгрузитьКолонку("УЗВИБ"));
		ДополнительныеСвойства.Вставить("СписокРолейIDM", Ссылка.РолиIDM.ВыгрузитьКолонку("РольIDM"));
	КонецЕсли;
	Если Модифицированность() Тогда
		ДатаПоследнегоИзменения = ТекущаяДата();
	КонецЕсли;
КонецПроцедуры

Процедура ПриЗаписи(Отказ)
	ЗапуститьОбновлениеРолей();
КонецПроцедуры

Процедура ЗапуститьОбновлениеРолей()
	НеобходимоОбновитьРоли=Ложь;
	//Для Каждого Строк Из УЗВИБ Цикл
	//	Если ДополнительныеСвойства.СписокУЗВИБ.Найти(Строк.УЗВИБ)=Неопределено Тогда
	//		НеобходимоОбновитьРоли = Истина;
	//		Прервать;
	//	КонецЕсли;
	//КонецЦикла;
	//Если Не НеобходимоОбновитьРоли Тогда
	//	Для Каждого УЗ Из ДополнительныеСвойства.СписокУЗВИБ Цикл
	//		Если УЗВИБ.Найти(УЗ, "УЗВИБ") = Неопределено Тогда
	//			НеобходимоОбновитьРоли = Истина;
	//			Прервать;
	//		КонецЕсли;	
	//	КонецЦикла;
	//КонецЕсли;
	Для Каждого Строк Из РолиIDM Цикл
		Если ДополнительныеСвойства.СписокРолейIDM.Найти(Строк.РольIDM)=Неопределено Тогда
			НеобходимоОбновитьРоли = Истина;
			Прервать;
		КонецЕсли;
	КонецЦикла;
	Если Не НеобходимоОбновитьРоли Тогда
		Для Каждого РольИДМ Из ДополнительныеСвойства.СписокРолейIDM Цикл
			Если РолиIDM.Найти(РольИДМ, "РольIDM") = Неопределено Тогда
				НеобходимоОбновитьРоли = Истина;
				Прервать;
			КонецЕсли;	
		КонецЦикла;
	КонецЕсли;
	Если НеобходимоОбновитьРоли Тогда
		NSI_Задания.ДобавитьЗадание("NSI_РаботаСПользователями.ОбновитьДанныеУЗВИБПоУЗИДМ", Новый Структура("УЗИДМ, ОчищатьНекорректныеРоли", Ссылка, Истина), "Обновляем данные пользователя ИДМ "+Ссылка);
		Возврат;
	КонецЕсли;
КонецПроцедуры

