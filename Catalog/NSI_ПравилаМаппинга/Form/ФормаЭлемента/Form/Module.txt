
&НаКлиенте
Процедура ТипОбъектаИсточникаНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	СтандартнаяОбработка = Ложь;
	СписокТиповМетаданных = Новый Массив;
	//СписокТиповМетаданных.Добавить("Документы");
	//СписокТиповМетаданных.Добавить("Справочники");
	ХранилищеБазы = ?(Элемент.Имя = "ТипОбъектаИсточника", Объект.Источник, Объект.Приемник);
	ИмяБазы = НайтиПроверочнуюБазу(ХранилищеБазы);
	Если Не ЗначениеЗаполнено(ИмяБазы) Тогда
		Сообщить("Укажите проверочную базу для хранилища "+ХранилищеБазы);
		Возврат;
	КонецЕсли;
	ОткрытьФорму("Справочник.NSI_СписокВИБ.Форма.ФормаПодбораМетаданных", Новый Структура("БазаИБ, СписокТиповМетаданных, ЗакрыватьПриВыборе", ИмяБазы, СписокТиповМетаданных, Истина), Элемент); 
КонецПроцедуры

&НаСервере
Функция НайтиПроверочнуюБазу(Хранилище)
		//{{КОНСТРУКТОР_ЗАПРОСА_С_ОБРАБОТКОЙ_РЕЗУЛЬТАТА
	// Данный фрагмент построен конструктором.
	// При повторном использовании конструктора, внесенные вручную изменения будут утеряны!!!

	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	СписокИБ.Ссылка
		|ИЗ
		|	Справочник.NSI_СписокВИБ КАК СписокИБ
		|ГДЕ
		|	СписокИБ.ИмяХранилища = &ИмяХранилища
		|	И СписокИБ.Проверочная
		|	И (НЕ СписокИБ.ПометкаУдаления)";

	Запрос.УстановитьПараметр("ИмяХранилища", Хранилище);

	Результат = Запрос.Выполнить();

	ВыборкаДетальныеЗаписи = Результат.Выбрать();

	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Возврат ВыборкаДетальныеЗаписи.Ссылка;
	КонецЦикла;

	//}}КОНСТРУКТОР_ЗАПРОСА_С_ОБРАБОТКОЙ_РЕЗУЛЬТАТА

КонецФункции


&НаКлиенте
Процедура БазаИсточникПриИзменении(Элемент)
	УстановитьОтборПоПравилуМаппинга();
КонецПроцедуры


&НаКлиенте
Процедура ПриОткрытии(Отказ)
	УстановитьОтборПоПравилуМаппинга();
КонецПроцедуры


&НаКлиенте
Процедура СписокРучногоМаппингаПриАктивизацииСтроки(Элемент)
	Если Не Элемент.ТекущиеДанные = Неопределено Тогда
		НастройкаМаппинга = Элемент.ТекущиеДанные.Ссылка;
	Иначе
		НастройкаМаппинга = Неопределено;
	КонецЕсли;
	УстановитьОтборПоНастройкеМаппинга(НастройкаМаппинга);
КонецПроцедуры


&НаСервере
Процедура УстановитьОтборПоПравилуМаппинга()
	ПолеМаппинга = Новый ПолеКомпоновкиДанных("ПравилоМаппинга");
	NSI_ОбщиеПроцедуры.УстановитьОтборУСписка(СписокРучногоМаппинга.Отбор, ПолеМаппинга, Объект.Ссылка);
КонецПроцедуры

&НаСервере
Процедура УстановитьОтборПоНастройкеМаппинга(НастройкаМаппинга)
	ПолеМаппинга = Новый ПолеКомпоновкиДанных("НастройкаМаппинга");
	NSI_ОбщиеПроцедуры.УстановитьОтборУСписка(НастройкиРучногоМаппинга.Отбор, ПолеМаппинга, НастройкаМаппинга);
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	УстановитьОтборПоПравилуМаппинга();
КонецПроцедуры

&НаКлиенте
Процедура СписокРучногоМаппингаПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа)
	Если Объект.Ссылка.Пустая() Тогда
		Сообщить("Необходимо сначала записать правило маппинга в базу");
		Отказ = Истина;
	КонецЕсли;
	УстановитьОтборПоПравилуМаппинга();
КонецПроцедуры

&НаКлиенте
Процедура НастройкиРучногоМаппингаПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа)
	Если Элементы.СписокРучногоМаппинга.ТекущиеДанные = Неопределено Тогда
		Сообщить("Необходимо сначала создать настройку ручного маппинга");
		Отказ = Истина;
	КонецЕсли;
КонецПроцедуры


