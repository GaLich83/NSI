&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	Если ЗначениеЗаполнено(Объект.Ссылка) Тогда
	Иначе
		Об = РеквизитФормыВЗначение("Объект");
		Об.УстановитьСсылкуНового(Справочники.NSI_ВидыМД.ПолучитьСсылку(Новый УникальныйИдентификатор));
	КонецЕсли;
	//ТаблицаЗначенийОписаниеПолей = NSI_РаботаСМастерДаннымиСерверПовторноеИспользование.ПолучитьОписаниеПолей(Объект.Ссылка);
	ТаблицаЗначенийОписаниеПолей = Объект.ОписаниеПолей.Выгрузить();
	ХэшДанныхОписанияПолей = NSI_РаботаСМастерДаннымиСервер.ПолучитьХэш(ТаблицаЗначенийОписаниеПолей);
	//NSI_РаботаСМастерДаннымиСервер.СоздатьТаблицуЗначенийНаФорме(ЭтаФорма, ТаблицаЗначенийОписаниеПолей, "ОписаниеПолей", "ИмяПоля, СинонимПоля, ИспользованиеПоля, Ключевое, Индексируемое, Периодическое");
	//НовыйРеквизит = Новый РеквизитФормы("ТипПоля", Новый ОписаниеТипов("ОписаниеТипов"), ИмяТаблицы, ПреобразоватьИмяЭлементаВТекст(Колонка.Имя));
	ТаблицаЗначенийОписаниеПолей.Колонки.Добавить("ТипПоляОписание", Новый ОписаниеТипов("ОписаниеТипов"));
	Для Каждого СтрокаОписаниеПолей Из ТаблицаЗначенийОписаниеПолей Цикл
		Если ЗначениеЗаполнено(СтрокаОписаниеПолей.ТипПоля) Тогда
			СтрокаОписаниеПолей.ТипПоляОписание = NSI_РаботаСМастерДаннымиСервер.ПрочитатьОбъектИзXML(СтрокаОписаниеПолей.ТипПоля);
		КонецЕсли;
	КонецЦикла;
	ТаблицаЗначенийОписаниеПолей.Колонки.Удалить("ТипПоля");
	ТаблицаЗначенийОписаниеПолей.Колонки.ТипПоляОписание.Имя = "ТипПоля";
	ЗначениеВРеквизитФормы(ТаблицаЗначенийОписаниеПолей, "ОписаниеПолей");
	Если ЗначениеЗаполнено(Объект.Ссылка) Тогда
		СписокКРазблокировке = Новый Массив;
		Попытка
		ЗаблокироватьДанныеДляРедактирования(Объект.Ссылка, , УникальныйИдентификатор);
		СписокКРазблокировке.Добавить("Объект");
		Отказ = Отказ ИЛИ Не NSI_РаботаСМастерДаннымиСервер.ЗаблокироватьДанныеПодчиненногоСправочникаДляИзменений(Объект.Ссылка, "NSI_МастерДанные", УникальныйИдентификатор);
		СписокКРазблокировке.Добавить("NSI_МастерДанные");
		Если Отказ Тогда
			ВызватьИсключение "Ошибка блокировки";
		КонецЕсли;
		Исключение
			Сообщить("Объект уже редактируется");
			Для Каждого ОбъектДляРазблокировки Из СписокКРазблокировке Цикл
				Если ОбъектДляРазблокировки = "Объект" Тогда
					РазблокироватьДанныеДляРедактирования(Объект.Ссылка, УникальныйИдентификатор);		
				Иначе
					NSI_РаботаСМастерДаннымиСервер.РазблокироватьДанныеПодчиненногоСправочникаДляИзменений(Объект.Ссылка, ОбъектДляРазблокировки, УникальныйИдентификатор);
				КонецЕсли;
			КонецЦикла;
			Отказ = Истина;
			СтандартнаяОбработка = Ложь;
			Возврат;
		КонецПопытки;		
	КонецЕсли;
	Элементы.Переместить(Элементы["ОписаниеПолей"], Элементы.СтраницаОписанияПолей);
	Если ЗначениеЗаполнено(Объект.МакетФормыМетаданныхЭлемента) Тогда
		МакетРасположенияЭлемента = NSI_РаботаСМастерДаннымиСервер.ПрочитатьОбъектИзXML(Объект.МакетФормыМетаданныхЭлемента);
	КонецЕсли;
	Если ЗначениеЗаполнено(Объект.МакетФормыМетаданныхГруппы) Тогда
		МакетРасположенияГруппы = NSI_РаботаСМастерДаннымиСервер.ПрочитатьОбъектИзXML(Объект.МакетФормыМетаданныхГруппы);
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ГруппаСтраницыПриСменеСтраницы(Элемент, ТекущаяСтраница)
	Если ТекущаяСтраница=Элементы.СтраницаРасположениеЭлемент Тогда
		NSI_РаботаСМастерДаннымиСервер.ПолучитьСписокДоступныхПолейМастерДанных(ЭтаФорма["ОписаниеПолей"], СписокПолейЭлемента, Ложь);
	ИначеЕсли ТекущаяСтраница = Элементы.СтраницаРасположениеГруппа Тогда
		NSI_РаботаСМастерДаннымиСервер.ПолучитьСписокДоступныхПолейМастерДанных(ЭтаФорма["ОписаниеПолей"], СписокПолейГруппы, Истина);
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура СписокПолейНачалоПеретаскивания(Элемент, ПараметрыПеретаскивания, Выполнение)
	ПараметрыПеретаскивания.ДопустимыеДействия = ДопустимыеДействияПеретаскивания.Перемещение;
	ПараметрыПеретаскивания.Значение = Элемент.ТекущиеДанные.Значение;
КонецПроцедуры

&НаКлиенте                                                                                 
Процедура МакетРасположенияПроверкаПеретаскивания(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, Область)
	Если ТипЗнч(ПараметрыПеретаскивания.Значение) = Тип("Строка") Тогда
		ПараметрыПеретаскивания.ДопустимыеДействия = ДопустимыеДействияПеретаскивания.Перемещение;
	КонецЕсли;
КонецПроцедуры

&НаСервере
Процедура ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
	ТаблицаЗначенийОписания = РеквизитФормыВЗначение("ОписаниеПолей");
	ТаблицаЗначенийОписания.Колонки.ТипПоля.Имя = "ТипПоляОписание";
	ТаблицаЗначенийОписания.Колонки.Добавить("ТипПоля", Новый ОписаниеТипов("Строка"));
	Для Каждого СтрокаОписания Из ТаблицаЗначенийОписания Цикл
		СтрокаОписания.ТипПоля = NSI_РаботаСМастерДаннымиСервер.ЗаписатьОбъектВXML(СтрокаОписания.ТипПоляОписание);
	КонецЦикла;
	ТаблицаЗначенийОписания.Колонки.Удалить("ТипПоляОписание");
	ТекущийОбъект.ОписаниеПолей.Загрузить(ТаблицаЗначенийОписания);
	NSI_РаботаСМастерДаннымиСервер.ПолучитьСписокДоступныхПолейМастерДанных(ТекущийОбъект.ОписаниеПолей, СписокПолейГруппы, Истина);
	NSI_РаботаСМастерДаннымиСервер.ПолучитьСписокДоступныхПолейМастерДанных(ТекущийОбъект.ОписаниеПолей, СписокПолейЭлемента, Ложь);
	ПроверитьЗаполнениеМакетовДанных(Отказ);
	Если Отказ Тогда
		Возврат;
	КонецЕсли;
	ТЗОписания = РеквизитФормыВЗначение("ОписаниеПолей");
	ОписаниеПолейГруппы = ТЗОписания.СкопироватьКолонки();
	ОписаниеПолейЭлемента = ТЗОписания.СкопироватьКолонки();
	Для Каждого Строк Из ТЗОписания Цикл
		Если Строк.ИспользованиеПоля = Перечисления.NSI_ИспользованиеПоляМД.ДляГруппы Тогда
			НоваяСтрокаГруппы = ОписаниеПолейГруппы.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрокаГруппы, Строк);
			Продолжить;
		КонецЕсли;
		Если Строк.ИспользованиеПоля = Перечисления.NSI_ИспользованиеПоляМД.ДляЭлемента Тогда
			НоваяСтрокаЭлемента = ОписаниеПолейЭлемента.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрокаЭлемента, Строк);
			Продолжить;
		КонецЕсли;
		НоваяСтрокаЭлемента = ОписаниеПолейЭлемента.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрокаЭлемента, Строк);
		НоваяСтрокаГруппы = ОписаниеПолейГруппы.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрокаГруппы, Строк);
	КонецЦикла;
	Отказ = Отказ ИЛИ Не NSI_РаботаСМастерДаннымиСервер.ОбновитьХэшиВсехМД(Объект.Ссылка, ОписаниеПолейГруппы, ОписаниеПолейЭлемента);
	Если Отказ Тогда
		Возврат;
	КонецЕсли;
	ТекущийОбъект.МакетФормыМетаданныхЭлемента = NSI_РаботаСМастерДаннымиСервер.ЗаписатьОбъектВXML(МакетРасположенияЭлемента);
	ТекущийОбъект.МакетФормыМетаданныхГруппы = NSI_РаботаСМастерДаннымиСервер.ЗаписатьОбъектВXML(МакетРасположенияГруппы);
КонецПроцедуры

&НаСервере
Процедура ПроверитьЗаполнениеМакетовДанных(Отказ)
	Отказ = Отказ ИЛИ Не NSI_РаботаСМастерДаннымиСервер.ПроверитьМакетВидаМастерДанных(МакетРасположенияГруппы, СписокПолейГруппы);
	Если Отказ Тогда
		Сообщить("Некорректное заполнение макета группы");
		Возврат;
	КонецЕсли;
	Отказ = Отказ ИЛИ Не NSI_РаботаСМастерДаннымиСервер.ПроверитьМакетВидаМастерДанных(МакетРасположенияЭлемента, СписокПолейЭлемента);
	Если Отказ Тогда
		Сообщить("Некорректное заполнение макета элемента");
		Возврат;
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ПроверитьМакет(Команда)
	Если Команда = Команды.Найти("ПроверитьМакетГруппы") Тогда
		МакетРасположения = МакетРасположенияГруппы;
		СписокПолей = СписокПолейГруппы;
	Иначе
		МакетРасположения = МакетРасположенияЭлемента;
		СписокПолей = СписокПолейЭлемента;
	КонецЕсли;
	Если NSI_РаботаСМастерДаннымиСервер.ПроверитьМакетВидаМастерДанных(МакетРасположения, СписокПолей) Тогда
		Сообщить("Макет заполнен правильно");
	Иначе
		Сообщить("Ошибка заполнения макета");
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ОписаниеПолейПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа, Параметр)
	// Вставить содержимое обработчика.
КонецПроцедуры

&НаКлиенте
Процедура КомандаЗаписатьИЗакрыть(Команда)
	ПараметрыЗаписи = Новый Структура;
	ПараметрыЗаписи.Вставить("Закрыть", Истина);
	Если Записать(ПараметрыЗаписи) Тогда
		Закрыть();
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ПередЗакрытием(Отказ, СтандартнаяОбработка)
	Если Модифицированность Тогда
		Отказ = Истина;
		ТекстВопроса = НСтр("ru = 'Данные были изменены. Сохранить изменения?'");
		Оповещение = Новый ОписаниеОповещения("ВопросПередЗакрытиемЗавершение", ЭтотОбъект);
		ПоказатьВопрос(Оповещение, ТекстВопроса, РежимДиалогаВопрос.ДаНетОтмена);
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ОписаниеПолейИмяПоляПриИзменении(Элемент)
	Элементы.ОписаниеПолей.ТекущиеДанные.СинонимПоля = NSI_РаботаСМастерДаннымиСервер.ПреобразоватьИмяЭлементаВТекст(Элементы.ОписаниеПолей.ТекущиеДанные.ИмяПоля);
КонецПроцедуры





