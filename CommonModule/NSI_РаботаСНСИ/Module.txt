Функция ПолучитьДанныеКонтрагента(ИНН="", КПП="", РегНомер = "") Экспорт
	ЗаполненныйЭлемент = ПолучитьЗаполненныйЭлементКонтрагента(ИНН, КПП, РегНомер);
	Если ЗначениеЗаполнено(ЗаполненныйЭлемент) И Не ЗаполненныйЭлемент.ОбособленноеПодразделение И ЗначениеЗаполнено(ЗаполненныйЭлемент.ИНН) 
		И ЗаполненныйЭлемент.ОсновнойКонтрагент И ЗаполненныйЭлемент.ДатаОбновленияИзСервиса<НачалоДня(ТекущаяДата()) Тогда
			Если СтрДлина(ИНН)=10 Тогда
				ОбновленныеДанные = ДанныеЕдиныхГосРеестров.РеквизитыЮридическогоЛицаПоИНН(ИНН);
			ИначеЕсли СтрДлина(ИНН)=12 Тогда
				ОбновленныеДанные = ДанныеЕдиныхГосРеестров.РеквизитыПредпринимателяПоИНН(ИНН);
			КонецЕсли;
	Иначе
		Если ЗначениеЗаполнено(ЗаполненныйЭлемент) И ЗаполненныйЭлемент.ОбособленноеПодразделение Тогда
			ПараметрыПроверки = Новый Структура;
			ПараметрыПроверки.Вставить("Контрагент", ЗаполненныйЭлемент);
			ПараметрыПроверки.Вставить("ИНН", ИНН);
			ПараметрыПроверки.Вставить("КПП", КПП);
			ПараметрыПроверки.Вставить("Дата", ТекущаяДата());
			ПараметрыПроверки.Вставить("СохранятьРезультатСразуПослеПроверки", Истина);
			АдресПроверки = ПоместитьВоВременноеХранилище(Неопределено);
			ПроверкаКонтрагентов.ПроверитьКонтрагента(ПараметрыПроверки, АдресПроверки);
			ОтветПроверки = ПолучитьИзВременногоХранилища(АдресПроверки);
			Если ОтветПроверки = Неопределено Тогда
				ВызватьИсключение "Сервис не вернул данных";
			ИначеЕсли ОтветПроверки = Перечисления.СостоянияСуществованияКонтрагента.Действует Тогда
			Иначе
				ВызватьИсключение Строка(ОтветПроверки);
			КонецЕсли;
		КонецЕсли;
		// Обновление данных по обособленному подразделению невозможно.		
		ОбновленныеДанные = Неопределено;
	КонецЕсли;
	Если ОбновленныеДанные = Неопределено Тогда
		Если Не ЗначениеЗаполнено(ЗаполненныйЭлемент) Тогда
			ВызватьИсключение "Контрагент не найден";
		КонецЕсли;
	Иначе
		Если ЗначениеЗаполнено(ЗаполненныйЭлемент) Тогда
			КонтрагентОбъект = ЗаполненныйЭлемент.ПолучитьОбъект();
		Иначе
			КонтрагентОбъект.СоздатьЭлемент();
		КонецЕсли;
		ЗаполнитьОбъектПоОтветуСервиса(КонтрагентОбъект, ОбновленныеДанные);
		КонтрагентОбъект.ДатаОбновленияИзСервиса = ТекущаяДата();
		КонтрагентОбъект.Записать();
		ЗаполненныйЭлемент = КонтрагентОбъект.Ссылка;
	КонецЕсли;
	Возврат СериализаторXDTO.ЗаписатьXDTO(ЗаполненныйЭлемент);
КонецФункции

Процедура ЗаполнитьОбъектПоОтветуСервиса(КонтрагентОбъект, ОбновленныеДанные)
	ЗаполнитьЗначенияСвойств(КонтрагентОбъект, ОбновленныеДанные);
	КонтрагентОбъект.ОсновнойКонтрагент = Истина;
	Если Не ОбновленныеДанные.ЮридическийАдрес=Неопределено Тогда
		КонтрагентОбъект.ЮридическийАдрес = ОбновленныеДанные.ЮридическийАдрес.Представление;
	КонецЕсли;
	Если Не ОбновленныеДанные.Телефон=Неопределено Тогда
		КонтрагентОбъект.Телефон = ОбновленныеДанные.Телефон.Представление;
	КонецЕсли;
	ЗаполнитьЗначенияСвойств(КонтрагентОбъект, ОбновленныеДанные.РегистрацияВФСС);
	Если Не ОбновленныеДанные.РегистрацияВНалоговомОргане=Неопределено Тогда
		КонтрагентОбъект.НалоговыйОрганКод = ОбновленныеДанные.РегистрацияВНалоговомОргане.Код;
		КонтрагентОбъект.НалоговыйОрганНаименование = ОбновленныеДанные.РегистрацияВНалоговомОргане.Наименование;
		КонтрагентОбъект.НалоговыйОрганОКТМО = ОбновленныеДанные.РегистрацияВНалоговомОргане.ОКТМО;
		КонтрагентОбъект.НалоговыйОрганОКАТО = ОбновленныеДанные.РегистрацияВНалоговомОргане.ОКАТО;
	КонецЕсли;
	Если Не ОбновленныеДанные.Руководитель=Неопределено Тогда
		КонтрагентОбъект.РуководительДолжность = ОбновленныеДанные.Руководитель.Должность;
		КонтрагентОбъект.РуководительФамилия = ОбновленныеДанные.Руководитель.Фамилия;
		КонтрагентОбъект.РуководительИмя = ОбновленныеДанные.Руководитель.Имя;
		КонтрагентОбъект.РуководительОтчество = ОбновленныеДанные.Руководитель.Отчество;
		КонтрагентОбъект.РуководительИНН = ОбновленныеДанные.Руководитель.ИНН;
	КонецЕсли;
	Если Не ОбновленныеДанные.РегистрацияВФСС=Неопределено Тогда
		КонтрагентОбъект.РегистрационныйНомерФСС = ОбновленныеДанные.РегистрацияВФСС.РегистрационныйНомерФСС;
		КонтрагентОбъект.КодПодчиненности = ОбновленныеДанные.РегистрацияВФСС.КодПодчиненности;
		КонтрагентОбъект.КодОрганаФСС = ОбновленныеДанные.РегистрацияВФСС.КодОрганаФСС;
		КонтрагентОбъект.НаименованиеОрганаФСС = ОбновленныеДанные.РегистрацияВФСС.НаименованиеОрганаФСС;
	КонецЕсли;
	Если СтрДлина(ОбновленныеДанные.ИНН)=12 Тогда
		КонтрагентОбъект.ЮридическоеФизическоеЛицо = Перечисления.NSI_ЮридическоеФизическоеЛицо.ЮридическоеЛицо;
		КонтрагентОбъект.СтранаРегистрации = Справочники.СтраныМира.Россия;
	ИначеЕсли СтрДлина(ОбновленныеДанные.ИНН)=10 Тогда
		КонтрагентОбъект.ЮридическоеФизическоеЛицо = Перечисления.NSI_ЮридическоеФизическоеЛицо.ФизическоеЛицо;
		КонтрагентОбъект.СтранаРегистрации = Справочники.СтраныМира.Россия;
		КодСтраны = Неопределено;
		Если ОбновленныеДанные.Свойство("КодСтраныГражданства", КодСтраны) Тогда
			КонтрагентОбъект.СтранаРегистрации = УправлениеКонтактнойИнформацией.ДанныеКлассификатораСтранМираПоКоду(КодСтраны);
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры

Функция ПолучитьЗаполненныйЭлементКонтрагента(ИНН, КПП, РегНомер)
	Запрос = Новый Запрос;
	ТекстЗапроса = "ВЫБРАТЬ ПЕРВЫЕ 1
	                                 |	NSI_Контрагенты.Ссылка
	                                 |ИЗ
	                                 |	Справочник.NSI_Контрагенты КАК NSI_Контрагенты
	                                 |ГДЕ
	                                 |	ИСТИНА";
	Если ЗначениеЗаполнено(ИНН) Тогда
		ТекстЗапроса = ТекстЗапроса + " И ИНН=&ИНН";
		Запрос.УстановитьПараметр("ИНН", ИНН);
	КонецЕсли;
	Если ЗначениеЗаполнено(КПП) Тогда
		ТекстЗапроса = ТекстЗапроса + " И КПП=&КПП";
		Запрос.УстановитьПараметр("КПП", КПП);
	КонецЕсли;
	Если ЗначениеЗаполнено(РегНомер) Тогда
		ТекстЗапроса = ТекстЗапроса + " И РегистрационныйНомер=&РегНомер";
		Запрос.УстановитьПараметр("РегНомер", РегНомер);
	КонецЕсли;
	Запрос.Текст = ТекстЗапроса;
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Возврат Выборка.Ссылка;
	Иначе
		Возврат Справочники.NSI_Контрагенты.ПустаяСсылка();
	КонецЕсли;
КонецФункции

Функция ПроверитьСтатусКонтрагентаПоИННКПП(ИНН, КПП) Экспорт
	ПараметрыПроверки = Новый Структура;
	//ПараметрыПроверки.Вставить("Контрагент", ЗаполненныйЭлемент);
	ПараметрыПроверки.Вставить("ИНН", ИНН);
	ПараметрыПроверки.Вставить("КПП", КПП);
	ПараметрыПроверки.Вставить("Дата", ТекущаяДата());
	ПараметрыПроверки.Вставить("СохранятьРезультатСразуПослеПроверки", Ложь);
	АдресПроверки = ПоместитьВоВременноеХранилище(Неопределено);
	
	ПроверкаКонтрагентов.ПроверитьКонтрагента(ПараметрыПроверки, АдресПроверки);
	ОтветПроверки = ПолучитьИзВременногоХранилища(АдресПроверки);
	Если ОтветПроверки = Неопределено Тогда
		ВызватьИсключение "Сервис не вернул данных";
	ИначеЕсли ТипЗнч(ОтветПроверки) = Тип("ПеречислениеСсылка.СостоянияСуществованияКонтрагента") Тогда
		Возврат XMLСтрока(ОтветПроверки);		
	Иначе
		ВызватьИсключение Строка(ОтветПроверки);
	КонецЕсли;
КонецФункции
